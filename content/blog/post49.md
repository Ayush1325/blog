+++
title = "My Week in Code #18"
description = "Updates regarding GitLab CI and BeagleBoard Rust Imager"
date = "2025-01-26T00:30:12+05:30"

[taxonomies]
tags = ["weekly-update", "beagleboard", "rust", "gitlab-ci"]
+++

Hello everyone. A typical week for development. Let's go over everything.

# GitLab CI Components

I have been using [GitLab Package Registry](https://docs.gitlab.com/ee/user/packages/package_registry/) for most of my projects. It allows a permanent registry to store packages and create releases, in a persistent fashion. Initially, I started with manually uploading the packages in the CI. However, this turned out to be difficult to maintain in [bb-imager-rs](https://openbeagle.org/ayush1325/bb-imager-rs), which has a lot of release packages.

Since I wanted the solution to be shareable across different repositories, I started looking around for solutions. I stumbled across [GitLab CI Components](https://docs.gitlab.com/ee/ci/components/). I would have preferred using [GitLab CI Steps](https://docs.gitlab.com/ee/ci/steps/), but since it is still experimental, I went with CI components.

Initially, I wanted to write the actual functionality in Python but quickly realized that it is not possible to depend on external files in CI components. You can download any external script in the CI from a URL, or you can create a custom container that already includes the script, but I decided to just go with writing everything in bash.

The CI Components are being used in [bb-imager-rs](https://openbeagle.org/ayush1325/bb-imager-rs) and [MicroBlocks](https://openbeagle.org/beagleboard/microblocks) and working pretty well. It should be fairly simple for other projects to start using them as well.

Let us now go over different CI Components present in the [repository](https://openbeagle.org/ayush1325/ci-components).

## Package Registry Upload

Upload all files in the directory following proper conventions to [GitLab Package Registry](https://docs.gitlab.com/ee/user/packages/package_registry/).

The release directory packages should follow the following format: `{RELEASE_DIR}/{PACKGE_NAME}/{PACKAGE_VERSION}/{PACKAGE_FILE}`. Here is an example of a release directory:

```bash
release/testpkg/0.0.1/abc.txt
release/testpkg/0.0.1-alpha/abc.txt
release/testpkg/0.0.1-alpha/abc.txt.bb.imager.json
```

Note: Any packages in a directory other than depth 3 will just be ignored.

The CI component also does some extra stuff:
1. Generate and upload sha256 checksum for all files.
2. Generate `release.yml` file which can be used by [release-from-file](@/blog/post49.md#release-from-file) to create a release.

Here is an example of using the CI component:

```yaml
include:
  - component: openbeagle.org/ayush1325/ci-components/package-registry-upload@$<VERSION>
    inputs:
      job-name: package-registry-upload-job
      job-stage: deploy
      job-needs: ["test-build"]
      release_dir: ${CI_PROJECT_DIR}/release
      release_template: ${CI_PROJECT_DIR}/release.yml
```

| Input | Default Value | Description |
| ----- | ------------- | ----------- |
| job-name | package-registry-upload-job | Name of the upload job |
| job-stage | deploy | Job stage |
| job-needs | [] | Job dependencies |
| release_dir | release | The directory containing packages to push to package registry |
| release_template | | Template with basic release information |

## Release from file

Create a release using [release-cli](https://docs.gitlab.com/ee/user/project/releases/release_cli.html) from the yaml file. It is possible to either use the file generated by [package-registry-upload](@/blog/post49.md#package-registry-upload) or just supply one manually.

The format of the file is not all that well defined, but I used the following [testfile](https://gitlab.com/gitlab-org/release-cli/-/blob/master/internal/testdata/release.yml?ref_type=heads) in the repository as reference.

The component optionally also supports generating [Changelog entries](https://docs.gitlab.com/ee/development/changelog.html) which is controlled by `changelog_generation` boolean variable.

Here is an example of using the CI component:

```yaml
include:
  - component: openbeagle.org/ayush1325/ci-components/release-from-file@$<VERSION>
    inputs:
      job-name: package-registry-upload-job
      job-stage: deploy
      job-needs: ["test-build"]
      release_file: ${CI_PROJECT_DIR}/release.yml
```

| Input | Default Value | Description |
| ----- | ------------- | ----------- |
| job-name | release-from-file-job | Name of the job |
| job-stage | deploy | Job stage |
| job-needs | [] | Job dependencies |
| release_file | | File to use to generate release |
| changelog_generation | false | Enable changelog generation |

## Os List

Create OS Lists subitems for use with [bb-imager](https://openbeagle.org/ayush1325/bb-imager-rs) config. This should prove useful for the subitems list of testing packages, which would need to be updated much more than stable images.

Note: Entries are only created for packages having associated `{package}.bb.imager.json` files with the following fields:
- name
- description
- icon
- devices
- tags

Here is an example of using the CI component:

```yaml
- component: $CI_SERVER_FQDN/$CI_PROJECT_PATH/os-list@$CI_COMMIT_SHA
  inputs:
    job-name: os-list-template
    job-needs: ["build-release-dir"]
    job-stage: deploy
    release_dir: release
    os_list_template: release/os_list_template.json
    os_list_suffix: "os_list/stable/os_list_template.json"
```

| Input | Default Value | Description |
| ----- | ------------- | ----------- |
| job-name | package-registry-upload-job | Name of the upload job |
| job-stage | deploy | Job stage |
| job-needs | [] | Job dependencies |
| release_dir | release | The directory containing packages to push to package registry |
| os_list_template | | Template with entries that will be appended to final os_list |
| os_list_url_suffix | | Suffix used to generate Package Registry URL for OS List |

# BeagleBoard Rust Imager

More work went into the BeagleBoard Rust imager this week. I hope to get the v1.0.0 release out by the end of this month and replace the old bb-imager.

## Remote Subitems

Similar to [Raspberry Pi Imager](https://github.com/raspberrypi/rpi-imager), [BeagleBoard Rust Imager](https://openbeagle.org/ayush1325/bb-imager-rs) now supports having subitems JSON list in a remote location. [Os List Component](@/blog/post49.md#os-list) can be used to generate the subitems JSON list in CI.

## Release v0.0.3

To test the new [CI components](@/blog/post49.md#gitlab-ci-components) (and since a new release has been long overdue), [BeagleBoard Rust Imager v0.0.3](https://openbeagle.org/ayush1325/bb-imager-rs/-/releases/v0.0.3) was released.

# Ending Thoughts

That is all for the week. Hopefully, this series will keep people updated about my work and attract potential contributors.

Consider [supporting me](@/pages/about.md) if you like my work.

# Helpful links

- [BeagleBoard](https://www.beagleboard.org/)
- [BeagleBoard Rust Imager](https://openbeagle.org/ayush1325/bb-imager-rs)
- [GitLab CI Components](https://openbeagle.org/ayush1325/ci-components)
